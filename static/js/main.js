var chartObj;
var leadChart;
var lines = [];
$(function() {
  $("#newsearch").submit(function(event) {
    event.stopPropagation();
    event.preventDefault();
    var query = document.getElementById("query-field").value;
    postJSON("/query-dimensions", { query: query }, function(result) {
      //console.log(result);
      lines[0] = Object.values(JSON.parse(result.body).year);
      //replace the geotag to everything but Canada
      query = query.replace(`="Canada" `, `!="Canada" `);
      console.log(query);
      //second query with !Canada
      postJSON("/query-dimensions", { query: query }, function(result) {
        lines[1] = Object.values(JSON.parse(result.body).year);
        lines[0].sort(function(first, second) {
          return first.id - second.id;
        });
        lines[1].sort(function(first, second) {
          return first.id - second.id;
        });
        console.log(lines);
        linedata = convertToLineData();
        console.log(linedata);
        chartObj.smoothing = 1;
        chartObj.updateXScale(
          new Date(linedata.xdomain[0], 0),
          new Date(linedata.xdomain[1], 0)
        );
        chartObj.updateYScale(linedata.ydomain[0], linedata.ydomain[1]);
        chartObj.updateLines(linedata.lines);
      });
    });
  });
  function convertToLineData() {
    result = {
      ydomain: [],
      xdomain: [],
      lines: [
        { name: "Canada", rawdata: [], data: [] },
        { name: "!Canada", rawdata: [], data: [] }
      ]
    };
    result.xdomain[0] = lines[0][0].id;
    result.xdomain[1] = lines[0][lines[0].length - 1].id;
    result.ydomain[0] = lines[0][0].count;
    result.ydomain[1] = lines[0][0].count;
    for (let j = 0; j < lines.length; j++) {
      for (let i = 0; i < lines[j].length; i++) {
        if (lines[j][i].count > result.ydomain[1]) {
          result.ydomain[1] = lines[j][i].count;
        }
        if (lines[j][i].count < result.ydomain[0]) {
          result.ydomain[0] = lines[j][i].count;
        }
        result.lines[j].rawdata[i] = {
          x: lines[j][i].id,
          y: lines[j][i].count
        };
        result.lines[j].data[i] = { x: lines[j][i].id, y: lines[j][i].count };
      }
    }
    return result;
  }
  // Create chart on page & data load.
  postJSON("unigramdata", {}, function(res) {
    // console.log(result)
    result = {
      ydomain: [0, 0.0005],
      xdomain: [1970, 2019],
      lines: [
        {
          name: "test0",
          rawdata: [
            { x: 1970, y: 3.179385292201497e-5 },
            { x: 1971, y: 3.795329406075466e-5 },
            { x: 1972, y: 4.499247209432338e-5 },
            { x: 1973, y: 5.296808876413529e-5 },
            { x: 1974, y: 6.192596963249424e-5 },
            { x: 1975, y: 7.189776568875961e-5 },
            { x: 1976, y: 8.289761566062391e-5 },
            { x: 1977, y: 9.491891176682654e-5 },
            { x: 1978, y: 0.00010793132972157645 },
            { x: 1979, y: 0.00012187829523294642 },
            { x: 1980, y: 0.00013667506222999468 },
            { x: 1981, y: 0.00015220757115751827 },
            { x: 1982, y: 0.00016833223796171572 },
            { x: 1983, y: 0.00018487679558811326 },
            { x: 1984, y: 0.00020164227043261947 },
            { x: 1985, y: 0.0002184061275652512 },
            { x: 1986, y: 0.0002349265628419188 },
            { x: 1987, y: 0.0002509478601290037 },
            { x: 1988, y: 0.0002662066712686269 },
            { x: 1989, y: 0.00028043901895412766 },
            { x: 1990, y: 0.0002933877723035829 },
            { x: 1991, y: 0.000304810305345002 },
            { x: 1992, y: 0.0003144860230774943 },
            { x: 1993, y: 0.000322223430669041 },
            { x: 1994, y: 0.0003278664300849499 },
            { x: 1995, y: 0.00033129955521528495 },
            { x: 1996, y: 0.0003324519003345273 },
            { x: 1997, y: 0.00033129955521528495 },
            { x: 1998, y: 0.0003278664300849499 },
            { x: 1999, y: 0.000322223430669041 },
            { x: 2000, y: 0.0003144860230774943 },
            { x: 2001, y: 0.000304810305345002 },
            { x: 2002, y: 0.0002933877723035829 },
            { x: 2003, y: 0.00028043901895412766 },
            { x: 2004, y: 0.0002662066712686269 },
            { x: 2005, y: 0.0002509478601290037 },
            { x: 2006, y: 0.0002349265628419188 },
            { x: 2007, y: 0.0002184061275652512 },
            { x: 2008, y: 0.00020164227043261947 },
            { x: 2009, y: 0.00018487679558811326 },
            { x: 2010, y: 0.00016833223796171572 },
            { x: 2011, y: 0.00015220757115751827 },
            { x: 2012, y: 0.00013667506222999468 },
            { x: 2013, y: 0.00012187829523294642 },
            { x: 2014, y: 0.00010793132972157645 },
            { x: 2015, y: 9.491891176682654e-5 },
            { x: 2016, y: 8.289761566062391e-5 },
            { x: 2017, y: 7.189776568875961e-5 },
            { x: 2018, y: 6.192596963249424e-5 },
            { x: 2019, y: 5.296808876413529e-5 }
          ],
          data: [
            { x: 1970, y: 3.179385292201497e-5 },
            { x: 1971, y: 3.795329406075466e-5 },
            { x: 1972, y: 4.499247209432338e-5 },
            { x: 1973, y: 5.296808876413529e-5 },
            { x: 1974, y: 6.192596963249424e-5 },
            { x: 1975, y: 7.189776568875961e-5 },
            { x: 1976, y: 8.289761566062391e-5 },
            { x: 1977, y: 9.491891176682654e-5 },
            { x: 1978, y: 0.00010793132972157645 },
            { x: 1979, y: 0.00012187829523294642 },
            { x: 1980, y: 0.00013667506222999468 },
            { x: 1981, y: 0.00015220757115751827 },
            { x: 1982, y: 0.00016833223796171572 },
            { x: 1983, y: 0.00018487679558811326 },
            { x: 1984, y: 0.00020164227043261947 },
            { x: 1985, y: 0.0002184061275652512 },
            { x: 1986, y: 0.0002349265628419188 },
            { x: 1987, y: 0.0002509478601290037 },
            { x: 1988, y: 0.0002662066712686269 },
            { x: 1989, y: 0.00028043901895412766 },
            { x: 1990, y: 0.0002933877723035829 },
            { x: 1991, y: 0.000304810305345002 },
            { x: 1992, y: 0.0003144860230774943 },
            { x: 1993, y: 0.000322223430669041 },
            { x: 1994, y: 0.0003278664300849499 },
            { x: 1995, y: 0.00033129955521528495 },
            { x: 1996, y: 0.0003324519003345273 },
            { x: 1997, y: 0.00033129955521528495 },
            { x: 1998, y: 0.0003278664300849499 },
            { x: 1999, y: 0.000322223430669041 },
            { x: 2000, y: 0.0003144860230774943 },
            { x: 2001, y: 0.000304810305345002 },
            { x: 2002, y: 0.0002933877723035829 },
            { x: 2003, y: 0.00028043901895412766 },
            { x: 2004, y: 0.0002662066712686269 },
            { x: 2005, y: 0.0002509478601290037 },
            { x: 2006, y: 0.0002349265628419188 },
            { x: 2007, y: 0.0002184061275652512 },
            { x: 2008, y: 0.00020164227043261947 },
            { x: 2009, y: 0.00018487679558811326 },
            { x: 2010, y: 0.00016833223796171572 },
            { x: 2011, y: 0.00015220757115751827 },
            { x: 2012, y: 0.00013667506222999468 },
            { x: 2013, y: 0.00012187829523294642 },
            { x: 2014, y: 0.00010793132972157645 },
            { x: 2015, y: 9.491891176682654e-5 },
            { x: 2016, y: 8.289761566062391e-5 },
            { x: 2017, y: 7.189776568875961e-5 },
            { x: 2018, y: 6.192596963249424e-5 },
            { x: 2019, y: 5.296808876413529e-5 }
          ]
        },
        {
          name: "test1",
          rawdata: [
            { x: 1970, y: 0.00028043901895412766 },
            { x: 1971, y: 0.0002933877723035829 },
            { x: 1972, y: 0.000304810305345002 },
            { x: 1973, y: 0.0003144860230774943 },
            { x: 1974, y: 0.000322223430669041 },
            { x: 1975, y: 0.0003278664300849499 },
            { x: 1976, y: 0.00033129955521528495 },
            { x: 1977, y: 0.0003324519003345273 },
            { x: 1978, y: 0.00033129955521528495 },
            { x: 1979, y: 0.0003278664300849499 },
            { x: 1980, y: 0.000322223430669041 },
            { x: 1981, y: 0.0003144860230774943 },
            { x: 1982, y: 0.000304810305345002 },
            { x: 1983, y: 0.0002933877723035829 },
            { x: 1984, y: 0.00028043901895412766 },
            { x: 1985, y: 0.0002662066712686269 },
            { x: 1986, y: 0.0002509478601290037 },
            { x: 1987, y: 0.0002349265628419188 },
            { x: 1988, y: 0.0002184061275652512 },
            { x: 1989, y: 0.00020164227043261947 },
            { x: 1990, y: 0.00018487679558811326 },
            { x: 1991, y: 0.00016833223796171572 },
            { x: 1992, y: 0.00015220757115751827 },
            { x: 1993, y: 0.00013667506222999468 },
            { x: 1994, y: 0.00012187829523294642 },
            { x: 1995, y: 0.00010793132972157645 },
            { x: 1996, y: 9.491891176682654e-5 },
            { x: 1997, y: 8.289761566062391e-5 },
            { x: 1998, y: 7.189776568875961e-5 },
            { x: 1999, y: 6.192596963249424e-5 },
            { x: 2000, y: 5.296808876413529e-5 },
            { x: 2001, y: 4.499247209432338e-5 },
            { x: 2002, y: 3.795329406075466e-5 },
            { x: 2003, y: 3.179385292201497e-5 },
            { x: 2004, y: 2.6449709863056185e-5 },
            { x: 2005, y: 2.185157424475791e-5 },
            { x: 2006, y: 1.7927866680644707e-5 },
            { x: 2007, y: 1.4606917077973783e-5 },
            { x: 2008, y: 1.1818778128697757e-5 },
            { x: 2009, y: 9.496655019831202e-6 },
            { x: 2010, y: 7.577968751325877e-6 },
            { x: 2011, y: 6.005083137174353e-6 },
            { x: 2012, y: 4.725734349538238e-6 },
            { x: 2013, y: 3.6932070099483393e-6 },
            { x: 2014, y: 2.8663027726520797e-6 },
            { x: 2015, y: 2.2091466286917526e-6 },
            { x: 2016, y: 1.69087338108314e-6 },
            { x: 2017, y: 1.2852324969092555e-6 },
            { x: 2018, y: 9.701443864303204e-7 },
            { x: 2019, y: 7.272355792048002e-7 }
          ],
          data: [
            { x: 1970, y: 0.00028043901895412766 },
            { x: 1971, y: 0.0002933877723035829 },
            { x: 1972, y: 0.000304810305345002 },
            { x: 1973, y: 0.0003144860230774943 },
            { x: 1974, y: 0.000322223430669041 },
            { x: 1975, y: 0.0003278664300849499 },
            { x: 1976, y: 0.00033129955521528495 },
            { x: 1977, y: 0.0003324519003345273 },
            { x: 1978, y: 0.00033129955521528495 },
            { x: 1979, y: 0.0003278664300849499 },
            { x: 1980, y: 0.000322223430669041 },
            { x: 1981, y: 0.0003144860230774943 },
            { x: 1982, y: 0.000304810305345002 },
            { x: 1983, y: 0.0002933877723035829 },
            { x: 1984, y: 0.00028043901895412766 },
            { x: 1985, y: 0.0002662066712686269 },
            { x: 1986, y: 0.0002509478601290037 },
            { x: 1987, y: 0.0002349265628419188 },
            { x: 1988, y: 0.0002184061275652512 },
            { x: 1989, y: 0.00020164227043261947 },
            { x: 1990, y: 0.00018487679558811326 },
            { x: 1991, y: 0.00016833223796171572 },
            { x: 1992, y: 0.00015220757115751827 },
            { x: 1993, y: 0.00013667506222999468 },
            { x: 1994, y: 0.00012187829523294642 },
            { x: 1995, y: 0.00010793132972157645 },
            { x: 1996, y: 9.491891176682654e-5 },
            { x: 1997, y: 8.289761566062391e-5 },
            { x: 1998, y: 7.189776568875961e-5 },
            { x: 1999, y: 6.192596963249424e-5 },
            { x: 2000, y: 5.296808876413529e-5 },
            { x: 2001, y: 4.499247209432338e-5 },
            { x: 2002, y: 3.795329406075466e-5 },
            { x: 2003, y: 3.179385292201497e-5 },
            { x: 2004, y: 2.6449709863056185e-5 },
            { x: 2005, y: 2.185157424475791e-5 },
            { x: 2006, y: 1.7927866680644707e-5 },
            { x: 2007, y: 1.4606917077973783e-5 },
            { x: 2008, y: 1.1818778128697757e-5 },
            { x: 2009, y: 9.496655019831202e-6 },
            { x: 2010, y: 7.577968751325877e-6 },
            { x: 2011, y: 6.005083137174353e-6 },
            { x: 2012, y: 4.725734349538238e-6 },
            { x: 2013, y: 3.6932070099483393e-6 },
            { x: 2014, y: 2.8663027726520797e-6 },
            { x: 2015, y: 2.2091466286917526e-6 },
            { x: 2016, y: 1.69087338108314e-6 },
            { x: 2017, y: 1.2852324969092555e-6 },
            { x: 2018, y: 9.701443864303204e-7 },
            { x: 2019, y: 7.272355792048002e-7 }
          ]
        }
      ]
    };

    chartObj = new D3Chart("#ngramchart", true);
    console.log(result);
    if (result.xdomain) {
      var xmin = new Date(result.xdomain[0], 0);
      var xmax = new Date(result.xdomain[1], 0);
    }
    chartObj.updateXScale(xmin, xmax);
    chartObj.updateYScale(result.ydomain[0], result.ydomain[1]);

    chartObj.updateLines(result.lines);
    //
    let yearlead =
      leadlag(result.lines[0].rawdata, result.lines[1].rawdata) + 1; // always seems to be 1 off.
    //
    //console.log('Test0 Leads Test1 by ', yearlead, 'years');
    //
    leadChart = new D3Chart("#leadlag", true);
    leadChart.updateXScale(xmin, xmax);
    leadChart.updateYScale(-0.0005, 0.0005);
    //// leadChart.updateYScale(result.ydomain[0], result.ydomain[1]);
    leadChart.updateLines(result.lines);
  });
});
